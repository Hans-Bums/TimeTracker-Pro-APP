<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#06B6D4">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ZeitTracker">
<link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
<link rel="shortcut icon" href="./icon-192.png">
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icon-192.png">
<title>ZeitTracker Pro - Cloud Sync</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #0f172a, #1e293b);
  color: white;
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 1400px; margin: 0 auto; }
.header {
  background: linear-gradient(to right, #1e293b, #0f172a);
  border-bottom: 1px solid rgba(6, 182, 212, 0.3);
  padding: 24px;
  border-radius: 16px 16px 0 0;
  margin-bottom: 20px;
}
.header h1 {
  font-size: 28px;
  background: linear-gradient(to right, #06B6D4, #3B82F6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 8px;
}
.header p { color: #94a3b8; font-size: 14px; }
.sync-status {
  display: inline-block;
  padding: 6px 16px;
  border-radius: 8px;
  font-size: 13px;
  margin-left: 12px;
  font-weight: 600;
}
.sync-status.connected {
  background: rgba(34, 197, 94, 0.2);
  color: #22C55E;
  border: 1px solid rgba(34, 197, 94, 0.4);
}
.sync-status.offline {
  background: rgba(251, 146, 60, 0.2);
  color: #FB923C;
  border: 1px solid rgba(251, 146, 60, 0.4);
}
.sync-status.error {
  background: rgba(239, 68, 68, 0.2);
  color: #EF4444;
  border: 1px solid rgba(239, 68, 68, 0.4);
}
.user-id-display {
  display: inline-block;
  padding: 4px 12px;
  background: rgba(6, 182, 212, 0.1);
  border: 1px solid rgba(6, 182, 212, 0.3);
  border-radius: 8px;
  font-size: 12px;
  margin-left: 8px;
  color: #06B6D4;
  cursor: pointer;
}
.tabs {
  display: flex;
  gap: 8px;
  margin-top: 16px;
  flex-wrap: wrap;
}
.tab {
  padding: 12px 24px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  background: rgba(51, 65, 85, 0.5);
  color: white;
  transition: all 0.3s;
}
.tab.active { background: #06B6D4; }
.tab:hover { opacity: 0.8; }
.card {
  background: rgba(30, 41, 59, 0.5);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(51, 65, 85, 0.5);
  border-radius: 16px;
  padding: 32px;
  margin-bottom: 20px;
}
.card h2 {
  font-size: 24px;
  color: #06B6D4;
  margin-bottom: 24px;
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 24px;
  margin-bottom: 24px;
}
.form-group label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: #cbd5e1;
  margin-bottom: 8px;
}
.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px;
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid #475569;
  border-radius: 12px;
  color: white;
  font-size: 14px;
  font-family: inherit;
}
.form-group textarea {
  min-height: 80px;
  resize: vertical;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #06B6D4;
}
.form-full {
  grid-column: 1 / -1;
}
.btn {
  padding: 16px 32px;
  background: linear-gradient(to right, #06B6D4, #3B82F6);
  color: white;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s;
}
.btn:hover { opacity: 0.9; transform: translateY(-2px); }
.btn-small { padding: 8px 16px; font-size: 14px; }
.btn-danger { background: #ef4444; }
.btn-success { background: #22C55E; }
.btn-warning { background: #F59E0B; }
.entry {
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid #334155;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 12px;
}
.entry-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 12px;
}
.entry-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.entry-note {
  margin-top: 12px;
  padding: 12px;
  background: rgba(6, 182, 212, 0.1);
  border-left: 3px solid #06B6D4;
  border-radius: 8px;
  font-size: 14px;
  color: #cbd5e1;
  font-style: italic;
}
.badge {
  padding: 4px 12px;
  background: rgba(51, 65, 85, 0.5);
  border-radius: 8px;
  font-size: 14px;
  color: #cbd5e1;
}
.tag {
  padding: 4px 12px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  color: white;
}
.bereich-item {
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid #334155;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 16px;
}
.bereich-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.color-picker {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid rgba(255,255,255,0.2);
}
.color-picker:hover {
  border-color: rgba(255,255,255,0.4);
  transform: scale(1.05);
  transition: all 0.2s;
}
.editable-name {
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.2s;
}
.editable-name:hover {
  background: rgba(6, 182, 212, 0.1);
}
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-content {
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 16px;
  padding: 32px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}
.modal h3 {
  font-size: 24px;
  color: #06B6D4;
  margin-bottom: 24px;
}
.hidden { display: none; }
.stat-card {
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid #334155;
  border-radius: 12px;
  padding: 20px;
}
.stat-big {
  font-size: 48px;
  font-weight: bold;
  color: #06B6D4;
  margin: 12px 0;
}
.color-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  margin-bottom: 16px;
}
.color-option {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid rgba(255,255,255,0.2);
  transition: all 0.2s;
}
.color-option:hover {
  transform: scale(1.1);
  border-color: white;
}
.color-section {
  margin-top: 16px;
  padding: 16px;
  background: rgba(15, 23, 42, 0.5);
  border-radius: 8px;
  border: 1px solid #334155;
}
.chart-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 24px;
  margin-top: 24px;
}
.chart-card {
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid #334155;
  border-radius: 12px;
  padding: 24px;
}
.chart-card h3 {
  font-size: 20px;
  color: #06B6D4;
  margin-bottom: 20px;
  text-align: center;
}
.pie-chart {
  width: 300px;
  height: 300px;
  margin: 0 auto 20px;
}
.legend {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
}
.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  flex-shrink: 0;
}
.legend-label {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.legend-value {
  font-weight: 600;
  color: #06B6D4;
}
.tooltip {
  position: absolute;
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid #06B6D4;
  border-radius: 8px;
  padding: 12px 16px;
  pointer-events: none;
  z-index: 1000;
  font-size: 14px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}
.info-box {
  background: rgba(6, 182, 212, 0.1);
  border: 1px solid rgba(6, 182, 212, 0.3);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
}
.info-box h3 {
  color: #06B6D4;
  font-size: 18px;
  margin-bottom: 8px;
}
.info-box p {
  color: #cbd5e1;
  font-size: 14px;
  line-height: 1.6;
}
.info-box code {
  background: rgba(15, 23, 42, 0.8);
  padding: 2px 8px;
  border-radius: 4px;
  color: #22C55E;
  font-family: monospace;
}
.export-buttons {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  flex-wrap: wrap;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 16px;">
      <div>
        <h1>‚è±Ô∏è ZeitTracker Pro <span class="sync-status" id="sync-status">‚è≥ Verbinde...</span>
          <span class="user-id-display" id="user-id-display" onclick="showUserIdModal()" title="Klick zum √Ñndern">üë§ User ID</span>
        </h1>
        <p>Professionelle Zeiterfassung mit Cloud-Synchronisation</p>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="showView('tracker')">Tracker</button>
      <button class="tab" onclick="showView('config')">Konfiguration</button>
      <button class="tab" onclick="showView('stats')">Statistiken</button>
    </div>
  </div>

  <div id="tracker-view">
    <div class="card">
      <h2>Neue Zeiterfassung</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>üìÖ Datum</label>
          <input type="date" id="entry-date">
        </div>
        <div class="form-group">
          <label>üïê Von</label>
          <input type="time" id="entry-start">
        </div>
        <div class="form-group">
          <label>üïê Bis</label>
          <input type="time" id="entry-end">
        </div>
        <div class="form-group">
          <label>Bereich</label>
          <select id="entry-bereich">
            <option value="">W√§hlen...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Aufgabe</label>
          <select id="entry-aufgabe">
            <option value="">W√§hlen...</option>
          </select>
        </div>
        <div class="form-group form-full">
          <label>üí¨ Notiz (optional)</label>
          <textarea id="entry-note" placeholder="z.B. Besprechung mit Team, Bug XY behoben, etc."></textarea>
        </div>
      </div>
      <button class="btn" onclick="addEntry()">‚ûï Eintrag hinzuf√ºgen</button>
    </div>

    <div class="card">
      <h2>Zeiteintr√§ge</h2>
      <div class="tabs" style="margin-bottom: 16px;">
        <button class="tab active" onclick="setTrackerPeriod('day')">Heute</button>
        <button class="tab" onclick="setTrackerPeriod('week')">Diese Woche</button>
        <button class="tab" onclick="setTrackerPeriod('month')">Dieser Monat</button>
        <button class="tab" onclick="setTrackerPeriod('all')">Alle</button>
      </div>
      <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">üí° Tipp: üí¨ Button f√ºr Notizen | ‚úèÔ∏è zum Bearbeiten | Doppelklick auch m√∂glich</p>
      <div id="entries-list"></div>
    </div>
  </div>

  <div id="config-view" class="hidden">
    <div class="info-box">
      <h3>üîÑ Cloud-Sync Einrichtung</h3>
      <p><strong>Wichtig:</strong> Damit PC und Handy synchronisiert werden, m√ºssen beide die gleiche <strong>User-ID</strong> verwenden!</p>
      <p style="margin-top: 8px;">üì± <strong>So richtest du es ein:</strong></p>
      <p style="margin-left: 16px;">1. Klicke oben auf deine User-ID (üë§)</p>
      <p style="margin-left: 16px;">2. Kopiere die ID</p>
      <p style="margin-left: 16px;">3. Auf dem anderen Ger√§t: Klicke User-ID ‚Üí F√ºge die gleiche ID ein</p>
      <p style="margin-top: 8px;">‚úÖ Jetzt sehen beide Ger√§te die gleichen Daten!</p>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>Bereiche</h2>
        <button class="btn btn-small" onclick="showAddModal('bereich')">‚ûï Bereich</button>
      </div>
      <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">üí° Tipp: Doppelklick auf Namen zum Bearbeiten</p>
      <div id="bereiche-list"></div>
    </div>
  </div>

  <div id="stats-view" class="hidden">
    <div class="card">
      <h2>üìä Zeitraum w√§hlen</h2>
      <div class="tabs" style="margin-bottom: 16px;">
        <button class="tab active" onclick="setStatsPeriod('day')">Heute</button>
        <button class="tab" onclick="setStatsPeriod('week')">Diese Woche</button>
        <button class="tab" onclick="setStatsPeriod('month')">Dieser Monat</button>
        <button class="tab" onclick="setStatsPeriod('all')">Alles</button>
      </div>
      <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid #334155; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <p style="color: #06B6D4; font-weight: 600; margin-bottom: 12px;">üóìÔ∏è Eigener Zeitraum:</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
          <div class="form-group" style="margin-bottom: 0;">
            <label>Von Datum</label>
            <input type="date" id="stats-date-from" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 8px; color: white;">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label>Bis Datum</label>
            <input type="date" id="stats-date-to" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 8px; color: white;">
          </div>
          <button class="btn btn-small" onclick="applyCustomDateRange()">Anwenden</button>
        </div>
      </div>
      <div class="export-buttons">
        <button class="btn btn-small btn-success" onclick="exportToExcel()">üìä Excel Export</button>
        <button class="btn btn-small btn-warning" onclick="exportToPDF()">üìÑ PDF Report</button>
      </div>
    </div>
    
    <div class="card">
      <div class="stat-card">
        <h2>Gesamtzeit</h2>
        <div class="stat-big" id="total-time">0h 0m</div>
        <p style="color: #94a3b8;" id="total-entries">0 Eintr√§ge</p>
      </div>
    </div>

    <div class="card">
      <h2>üìä Zeitverteilung</h2>
      <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">üí° Tipp: Maus √ºber Kuchen f√ºr Details</p>
      <div class="chart-container">
        <div class="chart-card">
          <h3>Nach Bereichen</h3>
          <svg id="pie-bereiche" class="pie-chart" viewBox="0 0 300 300"></svg>
          <div id="legend-bereiche" class="legend"></div>
        </div>
        
        <div class="chart-card">
          <h3>Nach Aufgaben</h3>
          <svg id="pie-aufgaben" class="pie-chart" viewBox="0 0 300 300"></svg>
          <div id="legend-aufgaben" class="legend"></div>
        </div>
        
        <div class="chart-card">
          <h3>Bereich + Aufgabe</h3>
          <svg id="pie-kombiniert" class="pie-chart" viewBox="0 0 300 300"></svg>
          <div id="legend-kombiniert" class="legend"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Detaillierte Statistiken</h2>
      <div id="stats-bereiche"></div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="userid-modal" class="modal hidden" onclick="if(event.target===this) closeUserIdModal()">
  <div class="modal-content">
    <h3>üîë Deine User-ID</h3>
    <p style="color: #cbd5e1; margin-bottom: 16px;">Diese ID verkn√ºpft deine Ger√§te. Kopiere sie und f√ºge sie auf deinem anderen Ger√§t ein!</p>
    <input type="text" id="userid-input" readonly 
           style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 12px; color: white; margin-bottom: 16px; font-family: monospace;">
    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
      <button class="btn btn-small" onclick="copyUserId()">üìã Kopieren</button>
      <button class="btn btn-small btn-warning" onclick="enableUserIdEdit()">‚úèÔ∏è √Ñndern</button>
    </div>
    <p style="color: #94a3b8; font-size: 13px; padding: 12px; background: rgba(251, 146, 60, 0.1); border-radius: 8px; border: 1px solid rgba(251, 146, 60, 0.3);">
      ‚ö†Ô∏è <strong>Wichtig:</strong> Beide Ger√§te m√ºssen die GLEICHE User-ID haben, damit sie synchronisiert werden!
    </p>
    <button class="btn" style="margin-top: 16px; background: #334155;" onclick="closeUserIdModal()">Schlie√üen</button>
  </div>
</div>

<div id="entry-edit-modal" class="modal hidden" onclick="if(event.target===this) closeEntryEditModal()">
  <div class="modal-content">
    <h3>üìù Eintrag bearbeiten</h3>
    <div class="form-grid" style="margin-bottom: 0;">
      <div class="form-group">
        <label>üìÖ Datum</label>
        <input type="date" id="edit-entry-date">
      </div>
      <div class="form-group">
        <label>üïê Von</label>
        <input type="time" id="edit-entry-start">
      </div>
      <div class="form-group">
        <label>üïê Bis</label>
        <input type="time" id="edit-entry-end">
      </div>
      <div class="form-group">
        <label>Bereich</label>
        <select id="edit-entry-bereich">
          <option value="">W√§hlen...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Aufgabe</label>
        <select id="edit-entry-aufgabe">
          <option value="">W√§hlen...</option>
        </select>
      </div>
      <div class="form-group form-full">
        <label>üí¨ Notiz (optional)</label>
        <textarea id="edit-entry-note" placeholder="z.B. Besprechung mit Team, Bug XY behoben, etc."></textarea>
      </div>
    </div>
    <div style="display: flex; gap: 12px; margin-top: 24px;">
      <button class="btn" onclick="saveEntryEdit()">üíæ Speichern</button>
      <button class="btn" style="background: #334155;" onclick="closeEntryEditModal()">Abbrechen</button>
    </div>
  </div>
</div>

<div id="add-modal" class="modal hidden" onclick="if(event.target===this) closeModal()">
  <div class="modal-content">
    <h3 id="modal-title">Hinzuf√ºgen</h3>
    <input type="text" id="modal-input" placeholder="Name eingeben..." 
           onkeypress="if(event.key==='Enter') confirmAdd()" 
           style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 12px; color: white; margin-bottom: 24px;">
    <div style="display: flex; gap: 12px;">
      <button class="btn" onclick="confirmAdd()">Hinzuf√ºgen</button>
      <button class="btn" style="background: #334155;" onclick="closeModal()">Abbrechen</button>
    </div>
  </div>
</div>

<div id="edit-modal" class="modal hidden" onclick="if(event.target===this) closeEditModal()">
  <div class="modal-content">
    <h3 id="edit-modal-title">Name bearbeiten</h3>
    <input type="text" id="edit-modal-input" placeholder="Neuer Name..." 
           onkeypress="if(event.key==='Enter') confirmEdit()" 
           style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 12px; color: white; margin-bottom: 24px;">
    <div style="display: flex; gap: 12px;">
      <button class="btn" onclick="confirmEdit()">Speichern</button>
      <button class="btn" style="background: #334155;" onclick="closeEditModal()">Abbrechen</button>
    </div>
  </div>
</div>

<div id="color-modal" class="modal hidden" onclick="if(event.target===this) closeColorModal()">
  <div class="modal-content">
    <h3>üé® Farbe w√§hlen</h3>
    <div class="color-grid">
      <div class="color-option" style="background: #EF4444" onclick="selectColor('#EF4444')"></div>
      <div class="color-option" style="background: #F97316" onclick="selectColor('#F97316')"></div>
      <div class="color-option" style="background: #F59E0B" onclick="selectColor('#F59E0B')"></div>
      <div class="color-option" style="background: #EAB308" onclick="selectColor('#EAB308')"></div>
      <div class="color-option" style="background: #84CC16" onclick="selectColor('#84CC16')"></div>
      <div class="color-option" style="background: #22C55E" onclick="selectColor('#22C55E')"></div>
      <div class="color-option" style="background: #10B981" onclick="selectColor('#10B981')"></div>
      <div class="color-option" style="background: #14B8A6" onclick="selectColor('#14B8A6')"></div>
      <div class="color-option" style="background: #06B6D4" onclick="selectColor('#06B6D4')"></div>
      <div class="color-option" style="background: #0EA5E9" onclick="selectColor('#0EA5E9')"></div>
      <div class="color-option" style="background: #3B82F6" onclick="selectColor('#3B82F6')"></div>
      <div class="color-option" style="background: #6366F1" onclick="selectColor('#6366F1')"></div>
      <div class="color-option" style="background: #8B5CF6" onclick="selectColor('#8B5CF6')"></div>
      <div class="color-option" style="background: #A855F7" onclick="selectColor('#A855F7')"></div>
      <div class="color-option" style="background: #D946EF" onclick="selectColor('#D946EF')"></div>
      <div class="color-option" style="background: #EC4899" onclick="selectColor('#EC4899')"></div>
      <div class="color-option" style="background: #F43F5E" onclick="selectColor('#F43F5E')"></div>
      <div class="color-option" style="background: #6B7280" onclick="selectColor('#6B7280')"></div>
      <div class="color-option" style="background: #1F2937" onclick="selectColor('#1F2937')"></div>
      <div class="color-option" style="background: #8B4513" onclick="selectColor('#8B4513')"></div>
    </div>
    <div class="color-section">
      <label style="display: block; margin-bottom: 8px; color: #cbd5e1;">Eigene Farbe:</label>
      <div style="display: flex; gap: 12px; align-items: center;">
        <input type="color" id="custom-color" value="#3B82F6" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
        <button class="btn btn-small" onclick="selectColor(document.getElementById('custom-color').value)">Verwenden</button>
      </div>
    </div>
    <button class="btn" style="margin-top: 16px; background: #334155;" onclick="closeColorModal()">Schlie√üen</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyADH6zeg4HmJc1tpvbTXiBFYN36aUbHIOA",
  authDomain: "timetracker-f31d1.firebaseapp.com",
  databaseURL: "https://timetracker-f31d1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "timetracker-f31d1",
  storageBucket: "timetracker-f31d1.firebasestorage.app",
  messagingSenderId: "716913179836",
  appId: "1:716913179836:web:d12cea606ac04c29aaa4b9"
};

let firebaseApp = null;
let database = null;
let isFirebaseConfigured = false;

try {
  firebaseApp = firebase.initializeApp(firebaseConfig);
  database = firebase.database();
  isFirebaseConfigured = true;
  updateSyncStatus('connected');
} catch (error) {
  console.error('Firebase init error:', error);
  updateSyncStatus('error');
}

function setCookie(name, value, days) {
  const expires = new Date();
  expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
  document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
}

function getCookie(name) {
  const nameEQ = name + '=';
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}

function getUserId() {
  let userId = localStorage.getItem('zeittracker-user-id');
  if (!userId) {
    userId = getCookie('zeittracker-user-id');
    if (userId) {
      localStorage.setItem('zeittracker-user-id', userId);
    }
  }
  if (!userId) {
    userId = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
    localStorage.setItem('zeittracker-user-id', userId);
    setCookie('zeittracker-user-id', userId, 3650);
  } else {
    setCookie('zeittracker-user-id', userId, 3650);
  }
  return userId;
}

function setUserId(newId) {
  localStorage.setItem('zeittracker-user-id', newId);
  setCookie('zeittracker-user-id', newId, 3650);
  state.userId = newId;
  updateUserIdDisplay();
  loadFromFirebase();
}

let state = {
  entries: [],
  bereiche: [],
  currentView: 'tracker',
  modalType: null,
  modalBereichId: null,
  statsPeriod: 'day',
  trackerPeriod: 'day',
  customDateFrom: null,
  customDateTo: null,
  colorEditType: null,
  colorEditId: null,
  colorEditBereichId: null,
  editType: null,
  editId: null,
  editBereichId: null,
  editingEntryId: null,
  userId: getUserId()
};

function updateSyncStatus(status) {
  const statusEl = document.getElementById('sync-status');
  statusEl.className = 'sync-status ' + status;
  if (status === 'connected') {
    statusEl.textContent = '‚òÅÔ∏è Cloud-Sync aktiv';
  } else if (status === 'offline') {
    statusEl.textContent = 'üíæ Nur lokal';
  } else if (status === 'error') {
    statusEl.textContent = '‚ùå Verbindungsfehler';
  }
}

function updateUserIdDisplay() {
  document.getElementById('user-id-display').textContent = 'üë§ ' + state.userId;
}

function showUserIdModal() {
  document.getElementById('userid-input').value = state.userId;
  document.getElementById('userid-input').readOnly = true;
  document.getElementById('userid-modal').classList.remove('hidden');
}

function closeUserIdModal() {
  document.getElementById('userid-modal').classList.add('hidden');
}

function copyUserId() {
  const input = document.getElementById('userid-input');
  input.select();
  document.execCommand('copy');
  alert('User-ID kopiert! F√ºge sie auf deinem anderen Ger√§t ein.');
}

function enableUserIdEdit() {
  const input = document.getElementById('userid-input');
  if (input.readOnly) {
    input.readOnly = false;
    input.focus();
    input.select();
    if (confirm('M√∂chtest du die User-ID √§ndern?\n\nWichtig: Nutze die GLEICHE ID auf allen Ger√§ten f√ºr die Synchronisation!')) {
      const newId = prompt('Neue User-ID eingeben (oder User-ID vom anderen Ger√§t):', state.userId);
      if (newId && newId.trim()) {
        setUserId(newId.trim());
        alert('User-ID ge√§ndert! Daten werden jetzt geladen...');
        closeUserIdModal();
      }
    }
  }
}

function syncToFirebase() {
  if (!isFirebaseConfigured) return;
  try {
    const userRef = database.ref('users/' + state.userId);
    userRef.set({
      entries: state.entries,
      bereiche: state.bereiche,
      lastUpdate: Date.now()
    });
    updateSyncStatus('connected');
  } catch (error) {
    console.error('Sync error:', error);
    updateSyncStatus('error');
  }
}

function loadFromFirebase() {
  if (!isFirebaseConfigured) {
    loadData();
    return;
  }
  try {
    const userRef = database.ref('users/' + state.userId);
    userRef.off();
    userRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        state.entries = data.entries || [];
        state.bereiche = data.bereiche || [];
        renderCurrentView();
        updateSyncStatus('connected');
      } else {
        state.entries = [];
        state.bereiche = [];
        loadData();
        renderCurrentView();
      }
    });
  } catch (error) {
    console.error('Load error:', error);
    updateSyncStatus('error');
    loadData();
  }
}

function loadData() {
  const savedEntries = localStorage.getItem('time-entries');
  const savedBereiche = localStorage.getItem('bereiche');
  if (savedEntries) state.entries = JSON.parse(savedEntries);
  if (savedBereiche) state.bereiche = JSON.parse(savedBereiche);
}

function saveData() {
  localStorage.setItem('time-entries', JSON.stringify(state.entries));
  localStorage.setItem('bereiche', JSON.stringify(state.bereiche));
  syncToFirebase();
}

function renderCurrentView() {
  if (state.currentView === 'tracker') renderEntries();
  if (state.currentView === 'config') renderBereiche();
  if (state.currentView === 'stats') renderStats();
  updateBereichSelect();
}

function showView(view) {
  state.currentView = view;
  document.getElementById('tracker-view').className = view === 'tracker' ? '' : 'hidden';
  document.getElementById('config-view').className = view === 'config' ? '' : 'hidden';
  document.getElementById('stats-view').className = view === 'stats' ? '' : 'hidden';
  document.querySelectorAll('.header .tab').forEach(tab => tab.classList.remove('active'));
  if (window.event && window.event.target && window.event.target.classList.contains('tab')) {
    window.event.target.classList.add('active');
  }
  if (view === 'tracker') renderEntries();
  if (view === 'config') renderBereiche();
  if (view === 'stats') renderStats();
}

function addEntry() {
  const date = document.getElementById('entry-date').value;
  const start = document.getElementById('entry-start').value;
  const end = document.getElementById('entry-end').value;
  const bereichId = document.getElementById('entry-bereich').value;
  const aufgabe = document.getElementById('entry-aufgabe').value;
  const note = document.getElementById('entry-note').value.trim();
  
  if (!date || !start || !end || !bereichId || !aufgabe) {
    alert('Bitte alle Felder ausf√ºllen!');
    return;
  }
  
  const bereich = state.bereiche.find(b => b.id == bereichId);
  if (!bereich) {
    alert('Bereich nicht gefunden!');
    return;
  }
  
  const aufgabeObj = bereich.aufgaben.find(a => a.name === aufgabe);
  
  state.entries.unshift({
    id: Date.now(),
    date,
    startTime: start,
    endTime: end,
    bereichId,
    aufgabe,
    note: note || '',
    bereichName: bereich.name,
    bereichColor: bereich.color,
    aufgabeColor: aufgabeObj?.color || '#3B82F6'
  });
  
  saveData();
  renderEntries();
  
  document.getElementById('entry-start').value = end;
  document.getElementById('entry-end').value = '';
  document.getElementById('entry-bereich').value = '';
  document.getElementById('entry-aufgabe').value = '';
  document.getElementById('entry-note').value = '';
}

function deleteEntry(id) {
  if (confirm('Eintrag wirklich l√∂schen?')) {
    state.entries = state.entries.filter(e => e.id !== id);
    saveData();
    renderEntries();
  }
}

function showEntryEditModal(entryId) {
  const entry = state.entries.find(e => e.id === entryId);
  if (!entry) return;
  state.editingEntryId = entryId;
  document.getElementById('edit-entry-date').value = entry.date;
  document.getElementById('edit-entry-start').value = entry.startTime;
  document.getElementById('edit-entry-end').value = entry.endTime;
  document.getElementById('edit-entry-note').value = entry.note || '';
  const bereichSelect = document.getElementById('edit-entry-bereich');
  bereichSelect.innerHTML = '<option value="">W√§hlen...</option>' + 
    state.bereiche.map(b => `<option value="${b.id}" ${b.id == entry.bereichId ? 'selected' : ''}>${b.name}</option>`).join('');
  updateEditAufgabeSelect(entry.aufgabe);
  document.getElementById('entry-edit-modal').classList.remove('hidden');
}

function closeEntryEditModal() {
  document.getElementById('entry-edit-modal').classList.add('hidden');
  state.editingEntryId = null;
}

function updateEditAufgabeSelect(selectedAufgabe = null) {
  const bereichId = document.getElementById('edit-entry-bereich').value;
  const select = document.getElementById('edit-entry-aufgabe');
  if (!bereichId) {
    select.innerHTML = '<option value="">W√§hlen...</option>';
    return;
  }
  const bereich = state.bereiche.find(b => b.id == bereichId);
  select.innerHTML = '<option value="">W√§hlen...</option>' + 
    (bereich?.aufgaben || []).map(a => `<option value="${a.name}" ${a.name === selectedAufgabe ? 'selected' : ''}>${a.name}</option>`).join('');
}

function saveEntryEdit() {
  const entry = state.entries.find(e => e.id === state.editingEntryId);
  if (!entry) return;
  const date = document.getElementById('edit-entry-date').value;
  const start = document.getElementById('edit-entry-start').value;
  const end = document.getElementById('edit-entry-end').value;
  const bereichId = document.getElementById('edit-entry-bereich').value;
  const aufgabe = document.getElementById('edit-entry-aufgabe').value;
  const note = document.getElementById('edit-entry-note').value.trim();
  if (!date || !start || !end || !bereichId || !aufgabe) {
    alert('Bitte alle Felder ausf√ºllen!');
    return;
  }
  const bereich = state.bereiche.find(b => b.id == bereichId);
  if (!bereich) {
    alert('Bereich nicht gefunden!');
    return;
  }
  const aufgabeObj = bereich.aufgaben.find(a => a.name === aufgabe);
  entry.date = date;
  entry.startTime = start;
  entry.endTime = end;
  entry.bereichId = bereichId;
  entry.aufgabe = aufgabe;
  entry.note = note || '';
  entry.bereichName = bereich.name;
  entry.bereichColor = bereich.color;
  entry.aufgabeColor = aufgabeObj?.color || '#3B82F6';
  saveData();
  renderEntries();
  closeEntryEditModal();
}

function renderEntries() {
  const list = document.getElementById('entries-list');
  const filteredEntries = getFilteredTrackerEntries();
  
  if (filteredEntries.length === 0) {
    const periodNames = {
      'day': 'heute',
      'week': 'diese Woche',
      'month': 'diesen Monat',
      'all': 'vorhanden'
    };
    list.innerHTML = `<p style="color: #94a3b8; text-align: center; padding: 32px 0;">Keine Eintr√§ge f√ºr ${periodNames[state.trackerPeriod]}</p>`;
    return;
  }
  list.innerHTML = filteredEntries.map(e => `
    <div class="entry" ondblclick="showEntryEditModal(${e.id})" style="cursor: pointer;" title="Doppelklick zum Bearbeiten">
      <div class="entry-header">
        <div style="flex: 1;">
          <div class="entry-meta">
            <span class="badge">üìÖ ${new Date(e.date).toLocaleDateString('de-DE')}</span>
            <span class="badge">üïê ${e.startTime} - ${e.endTime} <strong style="color: #06B6D4;">(${calculateDuration(e.startTime, e.endTime)})</strong></span>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <span class="tag" style="background-color: ${e.bereichColor}">${e.bereichName}</span>
            <span class="tag" style="background-color: ${e.aufgabeColor}">${e.aufgabe}</span>
          </div>
          ${e.note ? `<div class="entry-note">üí¨ ${e.note}</div>` : ''}
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-small" style="background: #06B6D4;" onclick="event.stopPropagation(); showEntryEditModal(${e.id})" title="Notiz ${e.note ? 'bearbeiten' : 'hinzuf√ºgen'}">üí¨</button>
          <button class="btn btn-small btn-warning" onclick="event.stopPropagation(); showEntryEditModal(${e.id})">‚úèÔ∏è</button>
          <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteEntry(${e.id})">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  `).join('');
}

function calculateDuration(start, end) {
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  const diff = (eh * 60 + em) - (sh * 60 + sm);
  if (diff < 0) return '0h 0m';
  return `${Math.floor(diff / 60)}h ${diff % 60}m`;
}

function updateBereichSelect() {
  const select = document.getElementById('entry-bereich');
  select.innerHTML = '<option value="">W√§hlen...</option>' + 
    state.bereiche.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
}

function updateAufgabeSelect() {
  const bereichId = document.getElementById('entry-bereich').value;
  const select = document.getElementById('entry-aufgabe');
  if (!bereichId) {
    select.innerHTML = '<option value="">W√§hlen...</option>';
    return;
  }
  const bereich = state.bereiche.find(b => b.id == bereichId);
  select.innerHTML = '<option value="">W√§hlen...</option>' + 
    (bereich?.aufgaben || []).map(a => `<option value="${a.name}">${a.name}</option>`).join('');
}

function showAddModal(type, bereichId = null) {
  state.modalType = type;
  state.modalBereichId = bereichId;
  document.getElementById('modal-title').textContent = type === 'bereich' ? 'Bereich hinzuf√ºgen' : 'Aufgabe hinzuf√ºgen';
  document.getElementById('modal-input').value = '';
  document.getElementById('add-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('modal-input').focus(), 100);
}

function closeModal() {
  document.getElementById('add-modal').classList.add('hidden');
}

function confirmAdd() {
  const name = document.getElementById('modal-input').value.trim();
  if (!name) {
    alert('Bitte einen Namen eingeben!');
    return;
  }
  if (state.modalType === 'bereich') {
    state.bereiche.push({
      id: Date.now(),
      name,
      color: '#3B82F6',
      aufgaben: []
    });
  } else if (state.modalType === 'aufgabe') {
    const bereich = state.bereiche.find(b => b.id === state.modalBereichId);
    if (bereich) {
      if (!bereich.aufgaben) bereich.aufgaben = [];
      bereich.aufgaben.push({
        id: Date.now(),
        name,
        color: '#3B82F6'
      });
    } else {
      alert('Fehler: Bereich nicht gefunden!');
      return;
    }
  }
  saveData();
  renderBereiche();
  updateBereichSelect();
  closeModal();
}

function showEditModal(type, id, bereichId = null) {
  state.editType = type;
  state.editId = id;
  state.editBereichId = bereichId;
  let currentName = '';
  if (type === 'bereich') {
    const bereich = state.bereiche.find(b => b.id === id);
    currentName = bereich?.name || '';
    document.getElementById('edit-modal-title').textContent = 'Bereich umbenennen';
  } else {
    const bereich = state.bereiche.find(b => b.id === bereichId);
    const aufgabe = bereich?.aufgaben.find(a => a.id === id);
    currentName = aufgabe?.name || '';
    document.getElementById('edit-modal-title').textContent = 'Aufgabe umbenennen';
  }
  document.getElementById('edit-modal-input').value = currentName;
  document.getElementById('edit-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('edit-modal-input').focus(), 100);
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.add('hidden');
}

function confirmEdit() {
  const newName = document.getElementById('edit-modal-input').value.trim();
  if (!newName) {
    alert('Bitte einen Namen eingeben!');
    return;
  }
  if (state.editType === 'bereich') {
    const bereich = state.bereiche.find(b => b.id === state.editId);
    if (bereich) bereich.name = newName;
  } else {
    const bereich = state.bereiche.find(b => b.id === state.editBereichId);
    if (bereich) {
      const aufgabe = bereich.aufgaben.find(a => a.id === state.editId);
      if (aufgabe) aufgabe.name = newName;
    }
  }
  saveData();
  renderBereiche();
  updateBereichSelect();
  closeEditModal();
}

function showColorPicker(type, id, bereichId = null) {
  state.colorEditType = type;
  state.colorEditId = id;
  state.colorEditBereichId = bereichId;
  document.getElementById('color-modal').classList.remove('hidden');
}

function closeColorModal() {
  document.getElementById('color-modal').classList.add('hidden');
}

function selectColor(color) {
  if (state.colorEditType === 'bereich') {
    const bereich = state.bereiche.find(b => b.id === state.colorEditId);
    if (bereich) bereich.color = color;
  } else if (state.colorEditType === 'aufgabe') {
    const bereich = state.bereiche.find(b => b.id === state.colorEditBereichId);
    if (bereich) {
      const aufgabe = bereich.aufgaben.find(a => a.id === state.colorEditId);
      if (aufgabe) aufgabe.color = color;
    }
  }
  saveData();
  renderBereiche();
  closeColorModal();
}

function deleteBereich(id) {
  if (confirm('Bereich wirklich l√∂schen?')) {
    state.bereiche = state.bereiche.filter(b => b.id !== id);
    saveData();
    renderBereiche();
    updateBereichSelect();
  }
}

function deleteAufgabe(bereichId, aufgabeId) {
  if (confirm('Aufgabe wirklich l√∂schen?')) {
    const bereich = state.bereiche.find(b => b.id === bereichId);
    if (bereich) {
      bereich.aufgaben = bereich.aufgaben.filter(a => a.id !== aufgabeId);
      saveData();
      renderBereiche();
    }
  }
}

function renderBereiche() {
  const list = document.getElementById('bereiche-list');
  if (state.bereiche.length === 0) {
    list.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 32px 0;">Noch keine Bereiche vorhanden</p>';
    return;
  }
  list.innerHTML = state.bereiche.map(b => `
    <div class="bereich-item">
      <div class="bereich-header">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div class="color-picker" style="background-color: ${b.color}" onclick="showColorPicker('bereich', ${b.id})" title="Farbe √§ndern"></div>
          <h3 class="editable-name" style="font-size: 20px;" ondblclick="showEditModal('bereich', ${b.id})" title="Doppelklick zum Bearbeiten">${b.name}</h3>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-small" onclick="showAddModal('aufgabe', ${b.id})">‚ûï Aufgabe</button>
          <button class="btn btn-small btn-danger" onclick="deleteBereich(${b.id})">üóëÔ∏è</button>
        </div>
      </div>
      ${b.aufgaben && b.aufgaben.length > 0 ? `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;">
          <h4 style="color: #06B6D4; margin-bottom: 12px;">Aufgaben (${b.aufgaben.length})</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
            ${b.aufgaben.map(a => `
              <div style="background: #1e293b; border: 1px solid #475569; border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                  <div class="color-picker" style="width: 24px; height: 24px; background-color: ${a.color}" onclick="showColorPicker('aufgabe', ${a.id}, ${b.id})" title="Farbe √§ndern"></div>
                  <span class="editable-name" style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" ondblclick="showEditModal('aufgabe', ${a.id}, ${b.id})" title="Doppelklick zum Bearbeiten">${a.name}</span>
                </div>
                <button class="btn btn-small btn-danger" onclick="deleteAufgabe(${b.id}, ${a.id})" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;">üóëÔ∏è</button>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `).join('');
}

function setStatsPeriod(period) {
  state.statsPeriod = period;
  state.customDateFrom = null;
  state.customDateTo = null;
  document.querySelectorAll('#stats-view .tabs .tab').forEach(tab => tab.classList.remove('active'));
  if (window.event && window.event.target) {
    window.event.target.classList.add('active');
  }
  renderStats();
}

function applyCustomDateRange() {
  const fromDate = document.getElementById('stats-date-from').value;
  const toDate = document.getElementById('stats-date-to').value;
  
  if (!fromDate || !toDate) {
    alert('Bitte beide Datumsfelder ausf√ºllen!');
    return;
  }
  
  if (new Date(fromDate) > new Date(toDate)) {
    alert('Von-Datum muss vor Bis-Datum liegen!');
    return;
  }
  
  state.statsPeriod = 'custom';
  state.customDateFrom = fromDate;
  state.customDateTo = toDate;
  
  // Deactivate all quick tabs
  document.querySelectorAll('#stats-view .tabs .tab').forEach(tab => tab.classList.remove('active'));
  
  renderStats();
}

function setTrackerPeriod(period) {
  state.trackerPeriod = period;
  document.querySelectorAll('#tracker-view .tabs .tab').forEach(tab => tab.classList.remove('active'));
  if (window.event && window.event.target) {
    window.event.target.classList.add('active');
  }
  renderEntries();
}

function getFilteredEntries() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  return state.entries.filter(entry => {
    const entryDate = new Date(entry.date + 'T00:00:00');
    const entryDateOnly = new Date(entryDate.getFullYear(), entryDate.getMonth(), entryDate.getDate());
    
    if (state.statsPeriod === 'custom' && state.customDateFrom && state.customDateTo) {
      const fromDate = new Date(state.customDateFrom + 'T00:00:00');
      const toDate = new Date(state.customDateTo + 'T00:00:00');
      return entryDateOnly >= fromDate && entryDateOnly <= toDate;
    } else if (state.statsPeriod === 'day') {
      return entryDateOnly.getTime() === today.getTime();
    } else if (state.statsPeriod === 'week') {
      const weekStart = new Date(today);
      const dayOfWeek = today.getDay();
      const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      weekStart.setDate(today.getDate() - diff);
      return entryDateOnly >= weekStart && entryDateOnly <= today;
    } else if (state.statsPeriod === 'month') {
      return entryDateOnly.getMonth() === now.getMonth() && entryDateOnly.getFullYear() === now.getFullYear();
    } else if (state.statsPeriod === 'all') {
      return true;
    }
    return true;
  });
}

function getFilteredTrackerEntries() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  return state.entries.filter(entry => {
    const entryDate = new Date(entry.date + 'T00:00:00');
    const entryDateOnly = new Date(entryDate.getFullYear(), entryDate.getMonth(), entryDate.getDate());
    
    if (state.trackerPeriod === 'day') {
      return entryDateOnly.getTime() === today.getTime();
    } else if (state.trackerPeriod === 'week') {
      const weekStart = new Date(today);
      const dayOfWeek = today.getDay();
      const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      weekStart.setDate(today.getDate() - diff);
      return entryDateOnly >= weekStart && entryDateOnly <= today;
    } else if (state.trackerPeriod === 'month') {
      return entryDateOnly.getMonth() === now.getMonth() && entryDateOnly.getFullYear() === now.getFullYear();
    } else if (state.trackerPeriod === 'all') {
      return true;
    }
    return true;
  });
}

function calculateStats() {
  const filtered = getFilteredEntries();
  const stats = { 
    total: 0, 
    bereiche: {}, 
    aufgaben: {},
    kombiniert: {}
  };
  filtered.forEach(entry => {
    const [sh, sm] = entry.startTime.split(':').map(Number);
    const [eh, em] = entry.endTime.split(':').map(Number);
    const duration = (eh * 60 + em) - (sh * 60 + sm);
    if (duration > 0) {
      stats.total += duration;
      stats.bereiche[entry.bereichName] = (stats.bereiche[entry.bereichName] || 0) + duration;
      stats.aufgaben[entry.aufgabe] = (stats.aufgaben[entry.aufgabe] || 0) + duration;
      const kombiKey = `${entry.bereichName} ‚Üí ${entry.aufgabe}`;
      stats.kombiniert[kombiKey] = (stats.kombiniert[kombiKey] || 0) + duration;
    }
  });
  return { stats, count: filtered.length };
}

function formatMinutes(minutes) {
  return `${Math.floor(minutes / 60)}h ${minutes % 60}m`;
}

function showTooltip(event, text) {
  let tooltip = document.getElementById('chart-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'chart-tooltip';
    tooltip.className = 'tooltip';
    document.body.appendChild(tooltip);
  }
  tooltip.innerHTML = text;
  tooltip.style.display = 'block';
  tooltip.style.left = (event.pageX + 10) + 'px';
  tooltip.style.top = (event.pageY + 10) + 'px';
}

function hideTooltip() {
  const tooltip = document.getElementById('chart-tooltip');
  if (tooltip) {
    tooltip.style.display = 'none';
  }
}

function createPieChart(svgId, data, total) {
  const svg = document.getElementById(svgId);
  svg.innerHTML = '';
  if (total === 0 || Object.keys(data).length === 0) {
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', '150');
    text.setAttribute('y', '150');
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', '#94a3b8');
    text.textContent = 'Keine Daten';
    svg.appendChild(text);
    return;
  }
  const centerX = 150;
  const centerY = 150;
  const radius = 100;
  let currentAngle = -90;
  Object.entries(data).forEach(([name, minutes]) => {
    const percentage = minutes / total;
    const angle = percentage * 360;
    if (angle > 0) {
      const startAngle = currentAngle * Math.PI / 180;
      const endAngle = (currentAngle + angle) * Math.PI / 180;
      const x1 = centerX + radius * Math.cos(startAngle);
      const y1 = centerY + radius * Math.sin(startAngle);
      const x2 = centerX + radius * Math.cos(endAngle);
      const y2 = centerY + radius * Math.sin(endAngle);
      const largeArc = angle > 180 ? 1 : 0;
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      const d = [
        `M ${centerX} ${centerY}`,
        `L ${x1} ${y1}`,
        `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,
        'Z'
      ].join(' ');
      path.setAttribute('d', d);
      let color = '#3B82F6';
      if (svgId === 'pie-bereiche') {
        const bereich = state.bereiche.find(b => b.name === name);
        color = bereich?.color || '#3B82F6';
      } else if (svgId === 'pie-aufgaben') {
        for (const bereich of state.bereiche) {
          const aufgabe = bereich.aufgaben.find(a => a.name === name);
          if (aufgabe) {
            color = aufgabe.color;
            break;
          }
        }
      } else if (svgId === 'pie-kombiniert') {
        const bereichName = name.split(' ‚Üí ')[0];
        const bereich = state.bereiche.find(b => b.name === bereichName);
        color = bereich?.color || '#3B82F6';
      }
      path.setAttribute('fill', color);
      path.setAttribute('stroke', '#1e293b');
      path.setAttribute('stroke-width', '2');
      path.style.cursor = 'pointer';
      const percentText = (percentage * 100).toFixed(1) + '%';
      const timeText = formatMinutes(minutes);
      const tooltipText = `<strong>${name}</strong><br>${timeText} (${percentText})`;
      path.addEventListener('mouseenter', (e) => showTooltip(e, tooltipText));
      path.addEventListener('mousemove', (e) => showTooltip(e, tooltipText));
      path.addEventListener('mouseleave', hideTooltip);
      svg.appendChild(path);
      currentAngle += angle;
    }
  });
}

function createLegend(legendId, data, total) {
  const legend = document.getElementById(legendId);
  if (total === 0 || Object.keys(data).length === 0) {
    legend.innerHTML = '<p style="color: #94a3b8; text-align: center;">Keine Daten f√ºr diesen Zeitraum</p>';
    return;
  }
  legend.innerHTML = Object.entries(data)
    .sort((a, b) => b[1] - a[1])
    .map(([name, minutes]) => {
      const percentage = ((minutes / total) * 100).toFixed(1);
      let color = '#3B82F6';
      if (legendId === 'legend-bereiche') {
        const bereich = state.bereiche.find(b => b.name === name);
        color = bereich?.color || '#3B82F6';
      } else if (legendId === 'legend-aufgaben') {
        for (const bereich of state.bereiche) {
          const aufgabe = bereich.aufgaben.find(a => a.name === name);
          if (aufgabe) {
            color = aufgabe.color;
            break;
          }
        }
      } else if (legendId === 'legend-kombiniert') {
        const bereichName = name.split(' ‚Üí ')[0];
        const bereich = state.bereiche.find(b => b.name === bereichName);
        color = bereich?.color || '#3B82F6';
      }
      return `
        <div class="legend-item">
          <div class="legend-color" style="background-color: ${color}"></div>
          <span class="legend-label" title="${name}">${name}</span>
          <span class="legend-value">${formatMinutes(minutes)} (${percentage}%)</span>
        </div>
      `;
    }).join('');
}

function renderStats() {
  const { stats, count } = calculateStats();
  document.getElementById('total-time').textContent = formatMinutes(stats.total);
  document.getElementById('total-entries').textContent = `${count} Eintr√§ge`;
  createPieChart('pie-bereiche', stats.bereiche, stats.total);
  createPieChart('pie-aufgaben', stats.aufgaben, stats.total);
  createPieChart('pie-kombiniert', stats.kombiniert, stats.total);
  createLegend('legend-bereiche', stats.bereiche, stats.total);
  createLegend('legend-aufgaben', stats.aufgaben, stats.total);
  createLegend('legend-kombiniert', stats.kombiniert, stats.total);
  
  const list = document.getElementById('stats-bereiche');
  if (Object.keys(stats.bereiche).length === 0) {
    list.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 32px 0;">Keine Daten f√ºr diesen Zeitraum</p>';
    return;
  }
  
  // Calculate task times per bereich
  const filtered = getFilteredEntries();
  const bereichTasks = {};
  filtered.forEach(entry => {
    if (!bereichTasks[entry.bereichName]) {
      bereichTasks[entry.bereichName] = {};
    }
    const [sh, sm] = entry.startTime.split(':').map(Number);
    const [eh, em] = entry.endTime.split(':').map(Number);
    const duration = (eh * 60 + em) - (sh * 60 + sm);
    if (duration > 0) {
      if (!bereichTasks[entry.bereichName][entry.aufgabe]) {
        bereichTasks[entry.bereichName][entry.aufgabe] = {
          minutes: 0,
          color: entry.aufgabeColor
        };
      }
      bereichTasks[entry.bereichName][entry.aufgabe].minutes += duration;
    }
  });
  
  list.innerHTML = Object.entries(stats.bereiche)
    .sort((a, b) => b[1] - a[1])
    .map(([name, minutes]) => {
      const bereich = state.bereiche.find(b => b.name === name);
      const percent = ((minutes / stats.total) * 100).toFixed(1);
      
      // Generate task list for this bereich
      const tasks = bereichTasks[name] || {};
      const taskHTML = Object.entries(tasks)
        .sort((a, b) => b[1].minutes - a[1].minutes)
        .map(([taskName, taskData]) => {
          const taskPercent = ((taskData.minutes / minutes) * 100).toFixed(1);
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0 8px 24px; border-left: 3px solid ${taskData.color}; margin-left: 12px; margin-top: 8px;">
              <span style="color: #94a3b8; font-size: 14px;">‚Ü≥ ${taskName}</span>
              <span style="color: #06B6D4; font-size: 14px; font-weight: 500;">${formatMinutes(taskData.minutes)} (${taskPercent}%)</span>
            </div>
          `;
        }).join('');
      
      return `
        <div class="stat-card" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <span style="font-weight: 500; font-size: 18px;">${name}</span>
            <span style="color: #06B6D4; font-weight: bold; font-size: 20px;">${formatMinutes(minutes)}</span>
          </div>
          <div style="width: 100%; background: #334155; border-radius: 9999px; height: 12px;">
            <div style="height: 12px; border-radius: 9999px; width: ${percent}%; background-color: ${bereich?.color || '#3B82F6'};"></div>
          </div>
          <p style="font-size: 12px; color: #94a3b8; margin-top: 8px;">${percent}% der Gesamtzeit</p>
          ${taskHTML}
        </div>
      `;
    }).join('');
}

function exportToExcel() {
  const filtered = getFilteredEntries().sort((a, b) => new Date(b.date) - new Date(a.date));
  if (filtered.length === 0) {
    alert('Keine Eintr√§ge zum Exportieren!');
    return;
  }
  const data = filtered.map(e => ({
    'Datum': new Date(e.date).toLocaleDateString('de-DE'),
    'Von': e.startTime,
    'Bis': e.endTime,
    'Dauer': calculateDuration(e.startTime, e.endTime),
    'Bereich': e.bereichName,
    'Aufgabe': e.aufgabe,
    'Notiz': e.note || ''
  }));
  const { stats } = calculateStats();
  const totalRow = {
    'Datum': '',
    'Von': '',
    'Bis': '',
    'Dauer': formatMinutes(stats.total),
    'Bereich': 'GESAMT',
    'Aufgabe': '',
    'Notiz': ''
  };
  data.push(totalRow);
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Zeiterfassung');
  const periodName = {
    'day': 'Heute',
    'week': 'Diese_Woche',
    'month': 'Dieser_Monat',
    'all': 'Alle',
    'custom': state.customDateFrom && state.customDateTo ? 
      `${state.customDateFrom}_bis_${state.customDateTo}` : 'Zeitraum'
  }[state.statsPeriod];
  XLSX.writeFile(wb, `Zeiterfassung_${periodName}_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function exportToPDF() {
  const filtered = getFilteredEntries().sort((a, b) => new Date(a.date) - new Date(b.date));
  if (filtered.length === 0) {
    alert('Keine Eintr√§ge zum Exportieren!');
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { stats, count } = calculateStats();
  doc.setFontSize(20);
  doc.text('ZEITERFASSUNG', 105, 20, { align: 'center' });
  doc.setFontSize(12);
  const periodName = {
    'day': 'Heute',
    'week': 'Diese Woche',
    'month': 'Dieser Monat',
    'all': 'Gesamter Zeitraum',
    'custom': state.customDateFrom && state.customDateTo ? 
      `${new Date(state.customDateFrom).toLocaleDateString('de-DE')} - ${new Date(state.customDateTo).toLocaleDateString('de-DE')}` : 'Eigener Zeitraum'
  }[state.statsPeriod];
  doc.text(`Zeitraum: ${periodName}`, 105, 30, { align: 'center' });
  doc.setFontSize(10);
  doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')}`, 105, 36, { align: 'center' });
  doc.setFontSize(14);
  doc.text('ZUSAMMENFASSUNG', 20, 50);
  doc.setFontSize(10);
  doc.text(`Gesamtzeit: ${formatMinutes(stats.total)}`, 20, 58);
  doc.text(`Anzahl Eintr√§ge: ${count}`, 20, 64);
  if (stats.total > 0) {
    const avgPerEntry = Math.round(stats.total / count);
    doc.text(`Durchschnitt/Eintrag: ${formatMinutes(avgPerEntry)}`, 20, 70);
  }
  doc.setFontSize(14);
  doc.text('DETAILLIERTE EINTR√ÑGE', 20, 85);
  doc.setFontSize(9);
  let yPos = 95;
  filtered.forEach((entry, index) => {
    if (yPos > 270) {
      doc.addPage();
      yPos = 20;
    }
    doc.setDrawColor(6, 182, 212);
    doc.line(20, yPos - 2, 190, yPos - 2);
    doc.text(`${new Date(entry.date).toLocaleDateString('de-DE')} | ${entry.startTime} - ${entry.endTime} | ${calculateDuration(entry.startTime, entry.endTime)}`, 20, yPos);
    yPos += 6;
    doc.text(`${entry.bereichName} ‚Üí ${entry.aufgabe}`, 20, yPos);
    yPos += 6;
    if (entry.note) {
      doc.setFont(undefined, 'italic');
      const noteLines = doc.splitTextToSize(`Notiz: ${entry.note}`, 170);
      noteLines.forEach(line => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        doc.text(line, 20, yPos);
        yPos += 5;
      });
      doc.setFont(undefined, 'normal');
    }
    yPos += 5;
  });
  if (yPos > 240) {
    doc.addPage();
    yPos = 20;
  }
  yPos += 10;
  doc.setFontSize(10);
  doc.text('Unterschrift Mitarbeiter: _________________________', 20, yPos);
  yPos += 10;
  doc.text('Unterschrift Vorgesetzter: _________________________', 20, yPos);
  const fileNamePeriod = {
    'day': 'Heute',
    'week': 'Diese_Woche',
    'month': 'Dieser_Monat',
    'all': 'Alle',
    'custom': state.customDateFrom && state.customDateTo ? 
      `${state.customDateFrom}_bis_${state.customDateTo}` : 'Zeitraum'
  }[state.statsPeriod];
  const fileName = `Zeiterfassung_${fileNamePeriod.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fileName);
}

function init() {
  updateUserIdDisplay();
  loadFromFirebase();
  const today = new Date().toISOString().split('T')[0];
  const now = new Date().toTimeString().slice(0, 5);
  document.getElementById('entry-date').value = today;
  document.getElementById('entry-start').value = now;
  updateBereichSelect();
  renderEntries();
  document.getElementById('entry-bereich').addEventListener('change', updateAufgabeSelect);
  document.getElementById('edit-entry-bereich').addEventListener('change', () => updateEditAufgabeSelect());
}

init();

// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => {
        console.log('Service Worker registered:', registration);
      })
      .catch(error => {
        console.log('Service Worker registration failed:', error);
      });
  });
}
</script>
</body>
</html>
